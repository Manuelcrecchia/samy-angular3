<div class="clouds"></div>

<div class="container py-4 page-wrap">
  <!-- TOP BAR -->
  <div class="top-actions d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
    <button class="btn btn-back-glass" (click)="back()">
      ‚¨Ö Torna Indietro
    </button>

    <!-- AZIONI SELEZIONE + INVIO -->
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <button
        class="btn btn-glass btn-round"
        (click)="toggleSelectAll()"
        [disabled]="employees.length === 0"
      >
        {{ allSelected ? "Deseleziona tutto" : "Seleziona tutto" }}
      </button>

      <span class="badge badge-dark">
        Selezionati: {{ selectedCount }}
      </span>

      <button
        class="btn btn-primary btn-round"
        (click)="openNotifyModal(notifyModal)"
        [disabled]="selectedCount === 0"
      >
        üîî Invia notifica
      </button>
    </div>
  </div>

  <h2 class="text-center page-title mb-4">Gestione Dipendenti</h2>

  <!-- TABLE WRAPPER -->
  <div class="table-wrapper">
    <table class="table align-middle text-center mb-0">
      <thead>
        <tr>
          <th style="width: 50px">
            <input
              type="checkbox"
              class="form-check-input"
              [checked]="allSelected"
              [indeterminate]="someSelected"
              (change)="toggleSelectAll()"
              [disabled]="employees.length === 0"
            />
          </th>
          <th>Nome</th>
          <th>Cognome</th>
          <th class="d-none d-md-table-cell">Email</th>
          <th class="d-none d-lg-table-cell">Telefono</th>
          <th style="min-width: 240px">Azioni</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let emp of employees">
          <td>
            <input
              type="checkbox"
              class="form-check-input"
              [checked]="isSelected(emp.id)"
              (change)="toggleEmployee(emp.id)"
            />
          </td>

          <td>{{ emp.nome }}</td>
          <td>{{ emp.cognome }}</td>
          <td class="d-none d-md-table-cell">{{ emp.email }}</td>
          <td class="d-none d-lg-table-cell">{{ emp.cellulare || "‚Äî" }}</td>

          <td class="actions-cell">
            <button
              class="btn btn-outline-brand btn-sm btn-round"
              (click)="goToAssenze(emp.id)"
            >
              üóìÔ∏è Assenze
            </button>

            <button
              class="btn btn-brand-secondary btn-sm btn-round"
              (click)="goToDocument(emp.id)"
            >
              üìÅ Documenti
            </button>

            <button
              class="btn btn-glass-dark btn-sm btn-round"
              (click)="openEmpNotifications(emp, empNotifModal)"
            >
              üîî Notifiche
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="employees.length === 0" class="alert alert-info text-center mt-3">
    Nessun dipendente trovato.
  </div>

  <!-- MODAL INVIO NOTIFICA -->
  <ng-template #notifyModal let-modal>
    <div class="modal-header modal-brand">
      <h5 class="modal-title">üîî Invia notifica</h5>
      <button
        type="button"
        class="btn-close"
        aria-label="Close"
        (click)="modal.dismiss()"
      ></button>
    </div>

    <div class="modal-body modal-body-glass">
      <div class="mb-2">
        <div class="small text-muted">
          Inviando a: <b>{{ selectedCount }}</b> dipendente/i
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">Titolo</label>
        <input
          type="text"
          class="form-control form-control-glass"
          [(ngModel)]="notifyTitle"
          maxlength="80"
          placeholder="Es. Avviso importante"
        />
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">Messaggio</label>
        <textarea
          class="form-control form-control-glass"
          rows="4"
          [(ngModel)]="notifyBody"
          maxlength="500"
          placeholder="Scrivi qui il testo della notifica..."
        ></textarea>
        <div class="small text-muted mt-1">
          {{ notifyBody.length || 0 }}/500
        </div>
      </div>

      <div *ngIf="notifyError" class="alert alert-danger py-2">
        {{ notifyError }}
      </div>

      <div *ngIf="notifySuccess" class="alert alert-success py-2">
        {{ notifySuccess }}
      </div>
    </div>

    <div class="modal-footer">
      <button
        class="btn btn-glass btn-round"
        (click)="modal.dismiss()"
        [disabled]="sending"
      >
        Annulla
      </button>

      <button
        class="btn btn-brand-primary btn-round"
        (click)="sendNotification(modal)"
        [disabled]="sending || !notifyTitle.trim() || !notifyBody.trim()"
      >
        <span
          *ngIf="sending"
          class="spinner-border spinner-border-sm me-2"
        ></span>
        Invia
      </button>
    </div>
  </ng-template>
</div>

<!-- MODAL NOTIFICHE DIPENDENTE -->
<ng-template #empNotifModal let-modal>
  <div class="modal-header modal-brand">
    <h5 class="modal-title">
      üîî Notifiche di {{ activeEmp?.nome }} {{ activeEmp?.cognome }}
    </h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body modal-body-glass">
    <div *ngIf="empNotifLoading" class="text-center py-4">
      <span class="spinner-border spinner-border-sm me-2"></span> Caricamento...
    </div>

    <div
      *ngIf="!empNotifLoading && empNotifs.length === 0"
      class="alert alert-info"
    >
      Nessuna notifica inviata a questo dipendente.
    </div>

    <div *ngIf="!empNotifLoading && empNotifs.length > 0" class="list-group">
      <div class="list-group-item list-item-glass" *ngFor="let n of empNotifs">
        <div class="d-flex justify-content-between align-items-start">
          <div class="me-3">
            <div class="fw-semibold">{{ n.title }}</div>
            <div class="small text-muted">{{ n.body }}</div>
            <div class="small text-muted mt-1">
              Inviata: {{ formatDate(n.createdAt) }}
            </div>
          </div>

          <span class="badge" [ngClass]="n.readAt ? 'bg-success' : 'bg-danger'">
            {{ n.readAt ? "VISTA" : "NON VISTA" }}
          </span>
        </div>

        <div *ngIf="n.readAt" class="small text-success mt-2">
          Vista il: {{ formatDate(n.readAt) }}
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn btn-glass btn-round" (click)="modal.dismiss()">
      Chiudi
    </button>
  </div>
</ng-template>